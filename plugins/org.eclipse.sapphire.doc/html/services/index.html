<!-- 
 ******************************************************************************
 * Copyright (c) 2011 Oracle and others
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Konstantin Komissarchik - initial implementation and ongoing maintenance
 ******************************************************************************
-->

<html>

<head>
  <title>Sapphire Services</title>
  <link rel="StyleSheet" href="../style.css" TYPE="text/css"/>
</head>

<body>

<h1>Services</h1>

<p>Many aspects of Sapphire can be extended by third parties.</p>

<ul>
  <li><a href="#DependenciesAggregationService">DependenciesAggregationService</a></li>
  <li><a href="#DependenciesService">DependenciesService</a></li>
  <li><a href="#FactsAggregationService">FactsAggregationService</a></li>
  <li><a href="#FactsService">FactsService</a></li>
  <li><a href="#FileExtensionsService">FileExtensionsService</a></li>  
</ul>


<a name="DependenciesAggregationService"><h2>DependenciesAggregationService</h2></a>

<p>The DependenciesAggregationService combines the data from all applicable dependencies services in order to produce 
a single set of dependencies. A dependency is a model paths that points to parts of the model that the property depends on. 
A property listens on all of its dependencies and triggers refresh when any of the dependencies change.</p>

<p>An implementation of this service is provided with Sapphire. This service is not intended to
be implemented by adopters. See <a href="#DependenciesService">DependenciesService</a> instead.</p>


<a name="DependenciesService"><h2>DependenciesService</h2></a>

<p>The DependenciesService produces the set of model paths that point to parts of the model that the property 
depends on. A property listens on all of its dependencies and triggers refresh when any of the dependencies change.</p>

<p>Although custom implementations are supported, in most cases the supplied implementation that is
configured via @DependsOn annotation should be sufficient.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code>@DependsOn( "Name" )

<font color="#888888">ValueProperty PROP_ID = new ValueProperty( TYPE, "Id" );

Value&lt;String> getId();
void setId( String value );</font></code></pre>

<p>Other annotations, such as @NoDuplicates can also inject implied dependencies (via their own DependenciesService
implementations). For instance, placing @NoDuplicates annotation on a Name property automatically
adds "#/Name" dependency.</p>

<p>If declarative approach is not sufficient, a custom DependenciesService implementation can be supplied.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code>public class CustomDependenciesService extends DependenciesService
{
    @Override
    protected void compute( Set&lt;ModelPath> dependencies )
    {
        // Compute the list of extensions.
    }
}</code></pre>

<pre class="source-code"><code>@Service( impl = CustomDependenciesService.class )

<font color="#888888">ValueProperty PROP_NAME = new ValueProperty( TYPE, "Name" );

Value&lt;String> getName();
void setName( String value );</font></code></pre>


<a name="FactsAggregationService"><h2>FactsAggregationService</h2></a>

<p>The FactsAggregationService combines the data from all applicable facts services in order to produce 
a single list of facts. A fact is a short statement describing property semantics.</p>

<p>An implementation of this service is provided with Sapphire. This service is not intended to
be implemented by adopters. See <a href="#FactsService">FactsService</a> to contribute facts.</p>


<a name="FactsService"><h2>FactsService</h2></a>

<p>When a property is described to a user in documentation one does it with a series of short statements that
define its semantics, such as "must be specified" or "maximum value is 100". When a property is
described to Sapphire one does it with a series of annotations, such as @Required or
@NumericRange. This duplicate specification is a maintenance problem.</p>

<p>A FactsService provides a means to dynamically derive statements about property's semantics
based on property's metadata. The derived facts can then be presented to the user as part of documentation,
property editor information popup and in other relevant places.</p>

<p>A single facts service can produce multiple facts and multiple facts services can be active 
concurrently for a given property. See <a href="#FactsAggregationService">FactsAggregationService</a> for 
an easier way to consume all facts.</p>

<p>Sapphire includes a number of FactsService implementations.</p> 

##facts-servicess##

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">This screen capture shows user experience with some of the provided FactsService 
implementation. See if you can match facts in the screen capture to service implementations above.</p>

<p style="margin-left: 20px;"><img src="images/FactsService.png"/></p>

<p>Adopters can provide custom FactService implementations either globally using Sapphire extension system or 
at the property level using @Service annotation.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">A simple global FactsService implementation that is triggered by a hypothetical 
@Since property annotation.</p>

<pre class="source-code"><code>public class SinceVersionFactsService extends FactsService
{
    @Override
    protected void facts( List facts )
    {
        Since since = property().getAnnotation( Since.class );
        facts.add( "Since version " + since.version() + "." );
    }

    public static class Factory extends ServiceFactory
    {
        @Override
        public boolean applicable( ServiceContext context,
                                   Class&lt;? extends Service> service )
        {
            return context.find( ModelProperty.class ).hasAnnotation( Since.class );
        }

        @Override
        public Service create( ServiceContext context,
                               Class&lt;? extends Service> service )
        {
            return new SinceVersionFactsService();
        }
    }
}</code></pre>

<p style="margin-left: 20px;">The service implementation is registered in META-INF/sapphire-extension.xml file.</p>

<pre class="source-code"><code><font color="#888888">&lt;extension xmlns="http://www.eclipse.org/sapphire/xmlns/extension"></font>
    &lt;service>
        &lt;id>Example.SinceVersionFactsService&lt;/id>
        &lt;type>org.eclipse.sapphire.services.FactsService&lt;/type>
        &lt;context>Sapphire.Property.Instance&lt;/context>
        &lt;factory>example.SinceVersionFactsService$Factory&lt;/factory>
    &lt;/service>
<font color="#888888">&lt;/extension></font></code></pre>

<p>Facts can also be statically specified for a given property by using @Fact annotation. Use @Facts
annotation to specify multiple facts. The facts contained in these annotations are surfaced by an
included FactsService implementation (id:Sapphire.FactsService.Static).</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">// *** ExampleOne ***</font>

@Fact( statement = "Important fact.")

<font color="#888888">ValueProperty PROP_EXAMPLE_ONE = new ValueProperty( TYPE, "ExampleOne" );

Value&lt;String> getExampleOne();
void setExampleOne( String value );

// *** ExampleMultiple ***</font>

@Facts( { @Fact( statement = "First important fact." ), @Fact( statement = "Second important fact." ) } )

<font color="#888888">ValueProperty PROP_EXAMPLE_MULTIPLE = new ValueProperty( TYPE, "ExampleMultiple" );

Value&lt;String> getExampleMultiple();
void setExampleMultiple( String value );</font></code></pre>


<a name="FileExtensionsService"><h2>FileExtensionsService</h2></a>

<p>The FileExtensionsService produces the list of file extensions that are allowed for a path value 
property.</p>

<p>Although custom implementations are supported, in most cases the supplied implementation that
is configured via @FileExtensions annotation should be sufficient. In many cases, specifying
file extensions is as simple as listing them with a comma in between.</p> 

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">@Type( base = Path.class )
@AbsolutePath
@MustExist
@ValidFileSystemResourceType( FileSystemResourceType.FILE )</font>
@FileExtensions( expr = "jar,zip" )

<font color="#888888">ValueProperty PROP_FILE_PATH = new ValueProperty( TYPE, "FilePath" );

Value&lt;Path> getFilePath();
void setFilePath( String value );
void setFilePath( Path value );</font></code></pre>

<p>File extensions can also be specified via an expression that takes into
account values of other properties.</p>

<p style="margin-left: 20px;"><b>Examples</b></p>

<pre class="source-code"><code>@FileExtensions( expr = "${ Extension }" )</code></pre>

<pre class="source-code"><code>@FileExtensions( expr = "${ LossyFormat ? "jpeg,jpg" : "png,gif" }" )</code></pre>

<p>If declarative approach is not sufficient, a custom FileExtensionsService implementation can
be supplied.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code>public class CustomFileExtensionsService extends FileExtensionsService
{
    @Override
    protected void initFileExtensionsService()
    {
        // Optionally register listeners to invoke refresh method when the list of extensions
        // may need to be updated.
    }

    @Override
    protected void compute( List&lt;String> extensions )
    {
        // Compute the list of extensions.
    }

    @Override
    public void dispose()
    {
        super.dispose();

        // Remove any listeners that were added during initialization.
    }
}</code></pre>

<pre class="source-code"><code><font color="#888888">@Type( base = Path.class )
@AbsolutePath
@MustExist
@ValidFileSystemResourceType( FileSystemResourceType.FILE )</font>
@Service( impl = CustomFileExtensionsService.class )

<font color="#888888">ValueProperty PROP_FILE_PATH = new ValueProperty( TYPE, "FilePath" );

Value&lt;Path> getFilePath();
void setFilePath( String value );
void setFilePath( Path value );</font></code></pre>


<div class="copyright">Copyright (c) 2011 Oracle<br/>
Content made available under the terms of <a href="http://www.eclipse.org/legal/epl-v10.html">Eclipse Public License</a>.</div>

</body>

</html>