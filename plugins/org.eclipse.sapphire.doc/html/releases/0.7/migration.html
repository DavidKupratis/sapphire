<!-- 
 ******************************************************************************
 * Copyright (c) 2013 Oracle
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Konstantin Komissarchik - initial implementation and ongoing maintenance
 ******************************************************************************
-->

<html>

<head>
  <title>Migration Guide for Sapphire 0.7</title>
  <link rel="StyleSheet" href="../../style.css" TYPE="text/css"/>
  <style type="text/css">
    pre.source-code 
    {
      font-family: Andale Mono, Lucida Console, Monaco, fixed, monospace; 
      color: #000000;
      background-color: #ffffff;
      font-size: 12px;
      border: 0px;
      line-height: 14px;
      padding: 5px;
      margin-left: 0px;
      margin-right: 0px;
      overflow: auto
    }
  </style>
</head>

<body>

<h1>Migration Guide for 0.7</h1>

<p>This documents covers code changes that need to be made by Sapphire adopters as part of migrating 
to 0.7 release. Only changes from the previous release are covered.</p>

<p>Table of Contents</p>

<ol>
  <li><a href="#ConversionService">ConversionService</a></li>
  <li><a href="#DateSerializationService">DateSerializationService</a></li>
  <li><a href="#GenerateImpl">GenerateImpl</a></li>
  <li><a href="#ModelElementType">ModelElementType</a></li>
  <li><a href="#ValueSerializationMasterService">ValueSerializationMasterService</a></li>
  <li><a href="#ValueSerializationService">ValueSerializationService</a></li>
  <li><a href="#XmlResource">XmlResource</a></li>
  <li><a href="#Service">@Service</a></li>
</ol>


<h2><a name="ConversionService">ConversionService</a></h2>

<table>
  <tr>
    <th>Before</th>
    <th>After</th>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">public class ExampleConversionService extends</font> ConversionService
<font color="#888888">{
    @Override
    public &lt;T> T convert( Object object, Class&lt;T> type )
    {
        if( object instanceof IFile && type == Resource.class )
        {
            ...
        }
        
        return null;
    }
}</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">public class ExampleConversionService extends</font> UniversalConversionService
<font color="#888888">{
    @Override
    public &lt;T> T convert( Object object, Class&lt;T> type )
    {
        if( object instanceof IFile && type == Resource.class )
        {
            ...
        }
        
        return null;
    }
}</font></code></pre>
    </td>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">public class ExampleConversionService extends ConversionService
{
    @Override
    public</font> &lt;T> T <font color="#888888">convert(</font> Object object, Class&lt;T> type <font color="#888888">)
    {</font>
        if( object instanceof IFile && type == Resource.class )
        {
            <font color="#888888">...</font>
        }
        
        return null;
    <font color="#888888">}
}</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">public class ExampleConversionService extends ConversionService</font>&lt;IFile,Resource>
<font color="#888888">{</font>
    protected ExampleConversionService()
    {
        super( IFile.class, Resource.class );
    }

    <font color="#888888">@Override
    public</font> Resource <font color="#888888">convert(</font> IFile file <font color="#888888">)
    {
        ...
    }
}</font></code></pre>

<p>While extending from UniversalConversionService is a quicker migration, in most cases, better performance can be
achieved by migrating to the new the ConversionService API. Conversions implemented in this manner are quicker for
Sapphire to find.</p>
    </td>
  </tr>
</table>


<h2><a name="DateSerializationService">DateSerializationService</a></h2>

<table>
  <tr>
    <th>Before</th>
    <th>After</th>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">@Type( base = Date.class )</font>

@Service
(
    impl = DateSerializationService.class, 
    params =
    { 
        @Service.Param( name = "format-1", value = "yyyy.MM.dd" ), 
        @Service.Param( name = "format-2", value = "MM/dd/yyyy" )
    }
)

<font color="#888888">ValueProperty PROP_DATE = new ValueProperty( TYPE, "Date" );

Value&lt;Date> getDate();
void setDate( String value );
void setDate( Date value );</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">@Type( base = Date.class )</font>

@Services
(
    {
        @Service
        (
            impl = StringToDateConversionService.class,
            params =
            { 
                @Service.Param( name = "format-1", value = "yyyy.MM.dd" ), 
                @Service.Param( name = "format-2", value = "MM/dd/yyyy" )
            },
            overrides = "Sapphire.ConversionService.StringToDate"
        ),
        @Service
        (
            impl = DateToStringConversionService.class,
            params = @Service.Param( name = "format", value = "yyyy.MM.dd" )
        )
    }
)

<font color="#888888">ValueProperty PROP_DATE = new ValueProperty( TYPE, "Date" );

Value&lt;Date> getDate();
void setDate( String value );
void setDate( Date value );</font></code></pre>
    </td>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code>public class ExampleDateSerializationService extends DateSerializationService
{
    @Override
    public List&lt;? extends DateFormat> formats()
    {
        ...
    }
}</code></pre>
    </td>
    <td>
<pre class="source-code"><code>public class TestStringToDateConversionService extends StringToDateConversionService
{
    @Override
    protected List&lt;? extends DateFormat> formats()
    {
        ...
    }
}
    
public class TestDateToStringConversionService extends DateToStringConversionService
{
    @Override
    protected DateFormat format()
    {
        ...
    }
}</code></pre>
    </td>
  </tr>
</table>


<h2><a name="GenerateImpl">GenerateImpl</a></h2>

<p>With the switch to on-demand element compilation, there is no longer a need to signal to the framework
which elements should be compiled. Also, the developer no longer has control over the name
of the generated implementation class. As such, the @GenerateImpl annotation has been removed and no direct 
equivalent has been provided. For further guidance, post a question 
on <a href="http://www.eclipse.org/forums/index.php?t=thread&frm_id=192">Sapphire Adopter Forum</a>.</p>


<h2><a name="ModelElementType">ModelElementType</a></h2>

<p>With the switch to on-demand element compilation, the developer no longer has control over the name
of the generated implementation class. As such, the following methods have been removed and no direct 
equivalents have been provided. For further guidance, post a question 
on <a href="http://www.eclipse.org/forums/index.php?t=thread&frm_id=192">Sapphire Adopter Forum</a>.</p>

<pre class="source-code"><code><font color="#888888">ModelElementType
{</font>
    Class<?> getImplClass()
    String getImplClassName( Class<?> elementTypeClass )
    String getImplClassName( String elementTypeClassName, GenerateImpl generateImplAnnotation )
    String getImplClassName( String elementTypeClassName, String preferredImplPackageName, String preferredImplClassName )
<font color="#888888">}</font></code></pre>


<h2><a name="ValueSerializationMasterService">ValueSerializationMasterService</a></h2>

<table>
  <tr>
    <th>Before</th>
    <th>After</th>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">Integer num = </font>(Integer) <font color="#888888">element.service( prop,</font> ValueSerializationMasterService<font color="#888888">.class ).</font>decode<font color="#888888">( str );</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">Integer num = element.service( prop,</font> MasterConversionService<font color="#888888">.class ).</font>convert<font color="#888888">( str</font>, Integer.class <font color="#888888">);</font></code></pre>
    </td>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">String str = </font>(String) <font color="#888888">element.service( prop,</font> ValueSerializationMasterService<font color="#888888">.class ).</font>encode<font color="#888888">( num );</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">String str = element.service( prop,</font> MasterConversionService<font color="#888888">.class ).</font>convert<font color="#888888">( num</font>, String.class <font color="#888888">);</font></code></pre>
    </td>
  </tr>
</table>


<h2><a name="ValueSerializationService">ValueSerializationService</a></h2>

<table>
  <tr>
    <th>Before</th>
    <th>After</th>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code>public class ExampleSerializationService extends ValueSerializationService
{
    @Override
    protected ExampleType decodeFromString( String value )
    {
        ...
    }
    
    public String encode( Object value )
    {
        ...
    }
}</code></pre>
    </td>
    <td>
<pre class="source-code"><code>public class StringToExampleTypeConversionService extends ConversionService&lt;String,ExampleType>
{
    public ExampleConversionService()
    {
        super( String.class, ExampleType.class );
    }

    @Override
    public ExampleType convert( String value )
    {
        ...
    }
}</code></pre>

<p>If the ValueSerializationService does not override the encode() method, then it is not necessary to supply a conversion to a string.
Sapphire includes a ConversionService implementation for converting an Object to a String that uses object's toString() method. This
matches the default implementation of the encode() method.</p>

<pre class="source-code"><code>public class ExampleTypeToStringTypeConversionService extends ConversionService&lt;ExampleType,String>
{
    public ExampleConversionService()
    {
        super( ExampleType.class, String.class );
    }

    @Override
    public String convert( ExampleType value )
    {
        ...
    }
}</code></pre>
    </td>
  </tr>
</table>


<h2><a name="XmlResource">XmlResource</a></h2>

<table>
  <tr>
    <th>Before</th>
    <th>After</th>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">XmlResource resource = ...
XmlResource parent = resource.parent();</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">XmlResource resource = ...
XmlResource parent =</font> (XmlResource) <font color="#888888">resource.parent();</font></code></pre>
    </td>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">XmlResource resource = ...
RootXmlResource root = resource.root();</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">XmlResource resource = ...
RootXmlResource root =</font> (RootXmlResource) <font color="#888888">resource.root();</font></code></pre>
    </td>
  </tr>
</table>


<h2><a name="Service">@Service</a></h2>

<p>Services registered with an @Service annotation on an element or a property will now be placed
in either metamodel or instance context, instead of both. Instance context is default, which is the
most common intention when using the @Service annotation. Registrations of services intended for the 
metamodel context will need an adjustment.</p>

<table>
  <tr>
    <th>Before</th>
    <th>After</th>
  </tr>
  <tr>
    <td>
<pre class="source-code"><code><font color="#888888">@Service( impl = ExampleService.class )</font></code></pre>
    </td>
    <td>
<pre class="source-code"><code><font color="#888888">@Service( impl = ExampleService.class</font>, context = Service.Context.METAMODEL <font color="#888888">)</font></code></pre>
    </td>
  </tr>
</table>


<div class="copyright">Copyright (c) 2013 Oracle<br/>
Content made available under the terms of <a href="http://www.eclipse.org/legal/epl-v10.html">Eclipse Public License</a>.</div>


</body>

</html>
