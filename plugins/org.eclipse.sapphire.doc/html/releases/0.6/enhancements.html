<!-- 
 ******************************************************************************
 * Copyright (c) 2012 Oracle
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Konstantin Komissarchik - initial implementation and ongoing maintenance
 ******************************************************************************
-->

<html>

<head>
  <title>Enhancements in Sapphire 0.6</title>
  <link rel="StyleSheet" href="../../style.css" TYPE="text/css"/>
</head>

<body>

<h1>Enhancements in 0.6</h1>

<ol>
  <li><a href="#VersionsAndVersionConstraints">Versions and Version Constraints</a></li>
  <li><a href="#ExpressionLanguage">Expression Language</a></li>
  <ol type="A">
    <li><a href="#ExpressionLanguage-EnabledFunction">Enabled Function</a></li>
    <li><a href="#ExpressionLanguage-UpperCaseFunction">UpperCase Function</a></li>
    <li><a href="#ExpressionLanguage-LowerCaseFunction">LowerCase Function</a></li>
    <li><a href="#ExpressionLanguage-UseInPageHeaderText">Use in Page Header Text</a></li>
    <li><a href="#ExpressionLanguage-UseInOutlineHeaderText">Use in Outline Header Text</a></li>
    <li><a href="#ExpressionLanguage-UseInConditional">Use in Conditional</a></li>
    <li><a href="#ExpressionLanguage-UseInSectionVisibilityConstraint">Use in Section Visibility Constraint</a></li>
    <li><a href="#ExpressionLanguage-UseInNodeVisibilityConstraint">Use in Node Visibility Constraint</a></li>
    <li><a href="#ExpressionLanguage-UseInNodeFactoryVisibilityConstraint">Use in Node Factory Visibility Constraint</a></li>
    <li><a href="#ExpressionLanguage-UseInPropertyEditorVisibilityConstraint">Use in Property Editor Visibility Constraint</a></li>
  </ol>
  <li><a href="#Miscellaneous">Miscellaneous</a></li>
  <ol type="A">
    <li><a href="#Miscellaneous-ConvertToFromNamespace">XmlUtil.convertToNamespaceFrom and convertFromNamespaceForm</a></li>
    <li><a href="#Miscellaneous-CollectionFactoriesEnhancements">Enhancements to Collection Factories</a></li>
    <li><a href="#Miscellaneous-MasterDetailsContentNode">MasterDetailsContentNode</a></li>
    <li><a href="#Miscellaneous-ModelElementList">ModelElementList</a></li>
    <li><a href="#Miscellaneous-SapphirePart">SapphirePart</a></li>
    <li><a href="#Miscellaneous-Value">Value</a></li>
  </ol>
</ol>


<h2><a name="VersionsAndVersionConstraints">Versions and Version Constraints</a></h2>

<p>In many complex Sapphire models, it is useful to be able to constrain functionality based on a version. To simplify these scenarios,
Sapphire now has native constructs for dealing with versions and version constraints.</p>

<p><b>Version</b> - Represents a version as a sequence of long integers. In string format, it is represented as a dot-separated
list of numeric segments, such as "1.2.3" or "5.7.3.2012070310003".</p>

<p><b>VersionConstraint</b> - A boolean expression that can check versions for applicability. In string 
format, it is represented as a comma-separated list of specific versions, closed 
ranges (expressed using "[1.2.3-4.5)" syntax and open ranges (expressed using "[1.2.3" or "4.5)" 
syntax). The square brackets indicate that the range includes the specified version. The parenthesis 
indicate that the range goes up to, but does not actually include the specified version.</p>

<p><b>Sapphire.version()</b> - Determines the version of Sapphire.</p>

<p>Both Version and VersionConstraint classes can be used as a type of a value property.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">// *** Version ***</font>
    
@Type( base = Version.class )

<font color="#888888">ValueProperty PROP_VERSION = new ValueProperty( TYPE, "Version" );
    
Value&lt;</font>Version<font color="#888888">> getVersion();
void setVersion( String value );
void setVersion(</font> Version <font color="#888888">value );
    
// *** VersionConstraint ***</font>
    
@Type( base = VersionConstraint.class )

<font color="#888888">ValueProperty PROP_VERSION_CONSTRAINT = new ValueProperty( TYPE, "VersionConstraint" );
    
Value&lt;</font>VersionConstraint<font color="#888888">> getVersionConstraint();
void setVersionConstraint( String value );
void setVersionConstraint(</font> VersionConstraint <font color="#888888">value );</font></code></pre>

<p>Further, version constraints can be evaluated in an expression via a pair of new functions. The VersionMatches function takes a version
as the first parameter, a version constraint as a second parameter and returns a boolean. The SapphireVersionMatches function takes a version
constraint as the sole parameter, evaluates it against Sapphire version and returns a boolean.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">In this example, the VersionMatches function is used to control property enablement.</p>

<pre class="source-code"><code><font color="#888888">// *** Provider ***
    
@Label( standard = "provider" )</font>
@Enablement( expr = "${ VersionMatches( Root().Version, '[1.1' ) }" )
<font color="#888888">@XmlBinding( path = "provider" )

ValueProperty PROP_PROVIDER = new ValueProperty( TYPE, "Provider" );

Value&lt;String> getProvider();
void setProvider( String value );</font></code></pre>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">In this example, the VersionMatches function is used in sdef to control visibility of a properties
view page.</p>

<pre class="source-code"><code><font color="#888888">&lt;properties-view>
    &lt;page>
        &lt;label>provider&lt;/label></font>
        &lt;visible-when>${ VersionMatches( Root().Version, '[1.1' ) }&lt;/visible-when>
        <font color="#888888">&lt;content>
            &lt;property-editor>Provider&lt;/property-editor>
            &lt;property-editor>
                &lt;property>Copyright&lt;/property>
                &lt;scale-vertically>true&lt;/scale-vertically>
            &lt;/property-editor>
        &lt;/content>
    &lt;/page>
&lt;/properties-view></font></code></pre>


<h2><a name="ExpressionLanguage"><a name="ExpressionLanguage-EnabledFunction">Enabled Function</a></a></h2>

<p>Determines if a property is enabled. Can be used either with two arguments (element and property name) or with
a single property name argument. In the single argument form, the context element is used.</p>

<p style="margin-left: 20px;"><b>Examples</b></p>

<p style="margin-left: 20px;">In these examples, the context element is Employee which has Assistant and Manager
properties. The first example asks if Assistant property is enabled for this employee. The second example asks
if Assistant property is enable for this employee's manager.</p>

<pre class="source-code"><code>${ Enabled( 'Assistant' ) }
${ Enabled( Manager, 'Assistant' ) }</code></pre>


<h2><a name="ExpressionLanguage-UpperCaseFunction">UpperCase Function</a></h2>

<p>Converts a string to upper case.</p>

<p style="margin-left: 20px;"><b>Examples</b></p>

<pre class="source-code"><code>${ UpperCase( Name ) }
${ Name.UpperCase() }</code></pre>


<h2><a name="ExpressionLanguage-LowerCaseFunction">LowerCase Function</a></h2>

<p>Converts a string to lower case.</p>

<p style="margin-left: 20px;"><b>Examples</b></p>

<pre class="source-code"><code>${ LowerCase( Name ) }
${ Name.LowerCase() }</code></pre>


<h2><a name="ExpressionLanguage-UseInPageHeaderText">Use EL in Page Header Text</a></h2>

<p>Use expression language when specifying editor page header text.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;editor-page>
    &lt;page-header-text></font>contacts (${ Contacts.Size })<font color="#888888">&lt;/page-header-text>
&lt;/editor-page></font></code></pre>


<h2><a name="ExpressionLanguage-UseInOutlineHeaderText">Use EL in Outline Header Text</a></h2>

<p>Use expression language when specifying master details outline header text.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;editor-page>
    &lt;outline-header-text></font>outline (${ Contacts.Size })<font color="#888888">&lt;/outline-header-text>
&lt;/editor-page></font></code></pre>


<h2><a name="ExpressionLanguage-UseInConditional">Use EL in Conditional</a></h2>

<p>Use expression language when specifying a conditional (if-then-else).</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;if>
    &lt;condition></font>${ VersionMatches( Root().Version, "[1.1" ) }<font color="#888888">&lt;/condition>
    &lt;then>
        ...
    &lt;/then>
    &lt;else>
        ...
    &lt;/else>
&lt;/if></font></code></pre>


<h2><a name="ExpressionLanguage-UseInSectionVisibilityConstraint">Use EL in Section Visibility Constraint</a></h2>

<p>Use expression language when specifying visibility of a section.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;section>
    &lt;visible-when></font>${ VersionMatches( Root().Version, "[1.1" ) }<font color="#888888">&lt;/condition>
    &lt;content>
        ...
    &lt;/content>
&lt;/section></font></code></pre>


<h2><a name="ExpressionLanguage-UseInNodeVisibilityConstraint">Use EL in Node Visibility Constraint</a></h2>

<p>Use expression language when specifying visibility of a master-details content node.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;node>
    &lt;visible-when></font>${ VersionMatches( Root().Version, "[1.1" ) }<font color="#888888">&lt;/condition>
    &lt;section>
        ...
    &lt;/section>
&lt;/node></font></code></pre>


<h2><a name="ExpressionLanguage-UseInNodeFactoryVisibilityConstraint">Use EL in Node Factory Visibility Constraint</a></h2>

<p>Use expression language when specifying visibility of a master-details content node factory.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;node-factory>
    &lt;property>Entities&lt;/property>
    &lt;visible-when></font>${ VersionMatches( Root().Version, "[1.1" ) }<font color="#888888">&lt;/condition>
    &lt;case>
        ...
    &lt;case>
&lt;/node-factory></font></code></pre>


<h2><a name="ExpressionLanguage-UseInPropertyEditorVisibilityConstraint">Use EL in Property Editor Visibility Constraint</a></h2>

<p>Use expression language when specifying visibility of a property editor.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;property-editor>
    &lt;property>Description&lt;/property>
    &lt;visible-when></font>${ VersionMatches( Root().Version, "[1.1" ) }<font color="#888888">&lt;/condition>
&lt;/property-editor></font></code></pre>


<h2><a name="Miscellaneous"><a name="Miscellaneous-ConvertToFromNamespace">XmlUtil.convertToNamespaceFrom and convertFromNamespaceForm</a></a></h2>

<p>Two static utility methods have been added to XmlUtil to make it easier to convert documents to and from namespace-qualified form.</p>

<pre class="source-code"><code>public static void convertToNamespaceForm( Document document, String namespace )
public static void convertToNamespaceForm( Document document, String namespace, String schemaLocation )
public static void convertFromNamespaceForm( Document document )</code></pre>


<h2><a name="Miscellaneous-CollectionFactoriesEnhancements">Enhancements to Collection Factories</a></h2>

<p>The collection factories have been enhanced with new methods to support broader range of use cases and a 
brand new SortedSetFactory.</p>

<pre class="source-code"><code><font color="#888888">ListFactory
{</font>
    static List&lt;E> empty()
    static List&lt;E> singleton( E element )
    static List&lt;E> unmodifiable( E... elements )
    static List&lt;E> unmodifiable( Collection&lt;E> elements )
    
    <font color="#888888">static ListFactory&lt;E> start()

    ListFactory&lt;E> add( E element )
    ListFactory&lt;E> add( E... element )
    ListFactory&lt;E> add( Collection&lt;E> element )</font>
    E remove( int index )
    E get( int index )
    boolean contains( E element )
    int size()
    
    <font color="#888888">ListFactory&lt;E> result()
}
 
SetFactory
{</font>
    static Set&lt;E> empty()
    static Set&lt;E> singleton( E element )
    static Set&lt;E> unmodifiable( E... elements )
    static Set&lt;E> unmodifiable( Collection&lt;E> elements )
    
    <font color="#888888">static SetFactory&lt;E> start()

    SetFactory&lt;E> add( E element )
    SetFactory&lt;E> add( E... element )
    SetFactory&lt;E> add( Collection&lt;E> element )</font>
    boolean remove( E element )
    boolean contains( E element )
    int size()
    
    <font color="#888888">SortedSet&lt;E> result()
}</font>
 
SortedSetFactory
{
    static SortedSet&lt;E> empty()
    static SortedSet&lt;E> singleton( E element )
    static SortedSet&lt;E> unmodifiable( E... elements )
    static SortedSet&lt;E> unmodifiable( Collection&lt;E> elements )
    
    static SortedSetFactory&lt;E> start()
    static SortedSetFactory&lt;E> start( Comparator&lt;E> comparator )
    
    SortedSetFactory&lt;E> add( E element )
    SortedSetFactory&lt;E> add( E... element )
    SortedSetFactory&lt;E> add( Collection&lt;E> element )
    boolean remove( E element )
    E first()
    E last()
    boolean contains( E element )
    int size()
    
    SortedSet&lt;E> result()
}
 
<font color="#888888">MapFactory
{</font>
    static Map&lt;K,V> empty()
    static Map&lt;K,V> singleton( K key, V value )
    static Map&lt;K,V> unmodifiable( Map&lt;K,V> map )
    
    <font color="#888888">static MapFactory&lt;K,V> start()

    MapFactory&lt;K,V> add( K key, V value )
    MapFactory&lt;K,V> add( Map&lt;K,V> map )</font>
    V remove( K key )
    V get( K key )
    boolean contains( K key )
    boolean containsKey( K key )
    boolean containsValue( V value )
    int size()
    
    <font color="#888888">Map&lt;K,V> result()
}</font></code></pre>


<h2><a name="Miscellaneous-MasterDetailsContentNode">MasterDetailsContentNode</a></h2>

<p>The method for accessing child nodes has been enhanced. The MasterDetailsContentNode.nodes() method now
returns a customized list object that provides additional operations specific to list of nodes. For instance,
there is a method to filter list of nodes to contain only visible nodes.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">The following produces all nodes whether or not they are visible.</p>

<pre class="source-code"><code>root.nodes()</font></code></pre>

<p style="margin-left: 20px;">A slight variation on the above statement produces only the visible nodes.</p>

<pre class="source-code"><code>root.nodes().visible()</font></code></pre>

<p>The new NodeListEvent provides notification when the list of child nodes changes. Note that this event
does not fire when child node visibility changes. See VisibilityChangedEvent for that functionality.</p>

<pre class="source-code"><code>node.attach
(
    new FilteredListener&lt;NodeListEvent>()
    {
        @Override
        protected void handleTypedEvent( NodeListEvent event )
        {
            ...
        }
    }
)</code></pre>


<h2><a name="Miscellaneous-ModelElementList">ModelElementList</a></h2>

<p>The new ModelElementList.enabled() method provides a simpler way to check list property's enablement
directly through the property accessor.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">The following two statements are equivalent.</p>

<pre class="source-code"><code>container.getEntities().enabled()</font></code></pre>

<pre class="source-code"><code>container.enabled( Container.PROP_ENTITIES )</code></pre>


<h2><a name="Miscellaneous-SapphirePart">SapphirePart</a></h2>

<p>Check part's visibility using SapphirePart.visible() method. To get notified of changes to part's visibility,
listen for VisibilityChangedEvent.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code>boolean visible = editor.visible()
 
editor.attach
(
    new FilteredListener&lt;VisibilityChangedEvent>()
    {
        @Override
        protected void handleTypedEvent( VisibilityChangedEvent event )
        {
            ...
        }
    }
)</code></pre>


<h2><a name="Miscellaneous-Value">Value</a></h2>

<p>The new Value.enabled() method provides a simpler way to check value property's enablement
directly through the property accessor.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">The following two statements are equivalent.</p>

<pre class="source-code"><code>entity.getName().enabled()</font></code></pre>

<pre class="source-code"><code>entity.enabled( Entity.PROP_NAME )</code></pre>


<div class="copyright">Copyright (c) 2012 Oracle<br/>
Content made available under the terms of <a href="http://www.eclipse.org/legal/epl-v10.html">Eclipse Public License</a>.</div>


</body>

</html>