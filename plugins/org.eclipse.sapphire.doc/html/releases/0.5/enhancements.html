<!-- 
 ******************************************************************************
 * Copyright (c) 2012 Oracle and Liferay
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Konstantin Komissarchik - initial implementation and ongoing maintenance
 *    Gregory Amerson - [372359] Provide means to extend the behavior of adapt methods
 *    Gregory Amerson - [358295] Need access to selection in list property editor
 ******************************************************************************
-->

<html>

<head>
  <title>Enhancements in Sapphire 0.5</title>
  <link rel="StyleSheet" href="../../style.css" TYPE="text/css"/>
</head>

<body>
<h1>Enhancements in 0.5</h1>
<ol>
  <li><a href="#UI">User Interface</a></li>
  <ol type="A">
    <li><a href="#MoreFlexibleActuatorPresentation">More Flexible Actuator Presentation</a></li>
    <li><a href="#PropagatedKeyBindings">Propagated Key Bindings</a></li>
    <li><a href="#ActionToolTips">Action Tool Tips</a></li>
    <li><a href="#PopUpListFieldForPossibleValues">Pop-Up List Field Presentation for Possible Value Properties</a></li>
  </ol>
  <li><a href="#DiagramEditor">Diagram Editor</a></li>
  <ol type="A">
    <li><a href="#DiagramLayout">Diagram Layout Storage</a></li>
    <li><a href="#DiagramContextHelp">Diagram Context Help</a></li>
    <li><a href="#NewDiagramActions">New Diagram Actions</a></li>
    <li><a href="#MutipleDiagramPartsActions">Actions for Multiple Diagram Parts</a></li>   
  </ol>
  <li><a href="#ExpressionLanguage">Expression Language</a></li>
  <ol type="A">
    <li><a href="#ImageFunction">Image Function</a></li>
    <li><a href="#ExprInPropertyEditorLabel">Use in Property Editor Label</a></li>
  </ol>
  <li><a href="#Services">Services</a></li>
  <ol type="A">
    <li><a href="#PartServices">Part Services</a></li>
    <li><a href="#AdapterService">AdapterService</a></li>
    <li><a href="#EqualityService">EqualityService</a></li>
    <li><a href="#ListSelectionService">ListSelectionService</a></li>
  </ol>
  <li><a href="#Miscellaneous">Miscellaneous</a></li>
  <ol type="A">
    <li><a href="#ModelElementDisposed">IModelElement.disposed()</a></li>
  </ol>
</ol>


<h2><a name="UI"><a name="MoreFlexibleActuatorPresentation">More Flexible Actuator Presentation</a></a></h2>

<p>An actuator provides means to invoke an action. The action could be drawn from the context where actuator 
is placed or provided as part of actuator's definition. Actuators were formerly limited to links and were
referred to as action links. New for this release is the ability to choose either link or button presentation
along with ability to control horizontal alignment.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;actuator>
    &lt;action-id>Sapphire.Gallery.Actuators.DoubleTheNumber&lt;/action-id>
    &lt;action>
        &lt;id>Sapphire.Gallery.Actuators.DoubleTheNumber&lt;/id>
        &lt;label>double the number&lt;/label>
    &lt;/action>
    &lt;action-handler>
        &lt;id>Sapphire.Gallery.Actuators.DoubleTheNumber&lt;/id>
        &lt;action>Sapphire.Gallery.Actuators.DoubleTheNumber&lt;/action>
        &lt;impl>ActuatorsGalleryDoubleTheNumberActionHandler&lt;/impl>
    &lt;/action-handler></font>
    &lt;span>false&lt;/span>
    &lt;horizontal-align>right&lt;/horizontal-align>
    &lt;style>Sapphire.Actuator.Button&lt;/style>
<font color="#888888">&lt;/actuator></font></code></pre>

<p style="margin-left: 20px;"><img src="images/MoreFlexibleActuatorPresentation.png"/></p>


<h2><a name="PropagatedKeyBindings">Propagated Key Bindings</a></h2>

<p>When processing keyboard events, the system now takes into account actions defined in part's hierarchy rather
than just the local ones. For instance, an action defined at editor page level can be made accessible via its
key binding even if the focus is on a property editor. This is done by specifying propagated key binding behavior
as part of action definition.</p> 

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;action>
    &lt;id>Sapphire.Gallery.Open.Homepage&lt;/id>
    &lt;label>Sapphire Homepage&lt;/label>
    &lt;tooltip>Open Sapphire Homepage (Ctrl+Alt+Shift+S)&lt;/tooltip>
    &lt;image>Web.png&lt;/image>
    &lt;description>Open Sapphire project homepage.&lt;/description>
    &lt;key-binding>CONTROL+ALT+SHIFT+s&lt;/key-binding></font>
    &lt;key-binding-behavior>propagated&lt;/key-binding-behavior>
    <font color="#888888">&lt;context>Sapphire.EditorPage&lt;/context>
    &lt;hint>
        &lt;name>style&lt;/name>
        &lt;value>image+text&lt;/value>
    &lt;/hint>
&lt;/action></font></code></pre>


<h2><a name="ActionToolTips">Action Tool Tips</a></h2>

<p>By default, action label is used when a tool tip is necessary. If that's not appropriate, developer can now
set the action tool tip explicitly.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;action>
    &lt;id>Sapphire.Gallery.Open.Homepage&lt;/id>
    &lt;label>Sapphire Homepage&lt;/label></font>
    &lt;tooltip>Open Sapphire Homepage (Ctrl+Alt+Shift+S)&lt;/tooltip>
    <font color="#888888">&lt;image>Web.png&lt;/image>
    &lt;description>Open Sapphire project homepage.&lt;/description>
    &lt;key-binding>CONTROL+ALT+SHIFT+s&lt;/key-binding>
    &lt;key-binding-behavior>propagated&lt;/key-binding-behavior>
    &lt;context>Sapphire.EditorPage&lt;/context>
    &lt;hint>
        &lt;name>style&lt;/name>
        &lt;value>image+text&lt;/value>
    &lt;/hint>
&lt;/action></font></code></pre>


<h2><a name="PopUpListFieldForPossibleValues">Pop-Up List Field Presentation for Possible Value Properties</a></h2>

<p>Two pop-up list field presentations (editable and strict) have been added for properties with a possible
values constraint. The default presentation remains a text field with a browse button and content
assist. The new presentations are available for both stand-alone property editors and when a property is
edited within a table.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">In this example, two properties are used to illustrate the different options. The Color property 
specifies an error for the severity of deviation from the possible values constraint, while the Shape 
property specifies a warning.</p>

<p style="margin-left: 20px;">The default presentation is a text field with a browse button and content assist.</p>

<p style="margin-left: 20px;"><img src="images/PopUpListFieldForPossibleValues-1.png"/></p>

<p style="margin-left: 20px;">An editable pop-up list field presentation can be used by specifying <nobr><i>Sapphire.PropertyEditor.PopUpListField.Editable</i></nobr> as 
the presentation style. This presentation is most appropriate when the severity of deviation from the possible values 
constraint is something other than an error.</p>

<pre class="source-code"><code><font color="#888888">&lt;property-editor>
    &lt;property>Color&lt;/property></font>
    &lt;style>Sapphire.PropertyEditor.PopUpListField.Editable&lt;/style>
<font color="#888888">&lt;/property-editor>
&lt;property-editor>
    &lt;property>Shape&lt;/property></font>
    &lt;style>Sapphire.PropertyEditor.PopUpListField.Editable&lt;/style>
<font color="#888888">&lt;/property-editor></font></code></pre>

<p style="margin-left: 20px;"><img src="images/PopUpListFieldForPossibleValues-2.png"/></p>

<p style="margin-left: 20px;">A strict pop-up list field presentation can be used by specifying <nobr><i>Sapphire.PropertyEditor.PopUpListField.Strict</i></nobr> as 
the presentation style. This presentation is most appropriate when the severity of deviation from the possible 
values constraint is an error.</p>

<pre class="source-code"><code><font color="#888888">&lt;property-editor>
    &lt;property>Color&lt;/property></font>
    &lt;style>Sapphire.PropertyEditor.PopUpListField.Strict&lt;/style>
<font color="#888888">&lt;/property-editor>
&lt;property-editor>
    &lt;property>Shape&lt;/property></font>
    &lt;style>Sapphire.PropertyEditor.PopUpListField.Strict&lt;/style>
<font color="#888888">&lt;/property-editor></font></code></pre>

<p style="margin-left: 20px;"><img src="images/PopUpListFieldForPossibleValues-3.png"/></p>

<p style="margin-left: 20px;">Alternatively, let the framework choose between editable and strict pop-up list field styles depending on the property's 
possible values constraint by specifying <nobr><i>Sapphire.PropertyEditor.PopUpListField</i></nobr> as the presentation style.</p>

<pre class="source-code"><code><font color="#888888">&lt;property-editor>
    &lt;property>Color&lt;/property></font>
    &lt;style>Sapphire.PropertyEditor.PopUpListField&lt;/style>
<font color="#888888">&lt;/property-editor>
&lt;property-editor>
    &lt;property>Shape&lt;/property></font>
    &lt;style>Sapphire.PropertyEditor.PopUpListField&lt;/style>
<font color="#888888">&lt;/property-editor></font></code></pre>

<p style="margin-left: 20px;"><img src="images/PopUpListFieldForPossibleValues-4.png"/></p>

<p style="margin-left: 20px;">The new presentations are accessible in a similar manner when properties are edited within
a table.</p>

<pre class="source-code"><code><font color="#888888">&lt;property-editor>
    &lt;property>ColoredShapes&lt;/property>
    &lt;show-label>false&lt;/show-label>
    &lt;span>true&lt;/span>
    &lt;child-property>
        &lt;property>Color&lt;/property></font>
        &lt;style>Sapphire.PropertyEditor.PopUpListField&lt;/style>
    <font color="#888888">&lt;/child-property>
    &lt;child-property>
        &lt;property>Shape&lt;/property></font>
        &lt;style>Sapphire.PropertyEditor.PopUpListField&lt;/style>
    <font color="#888888">&lt;/child-property>
&lt;/property-editor></font></code></pre>

<p style="margin-left: 20px;"><img src="images/PopUpListFieldForPossibleValues-5.png"/></p>


<h2><a name="DiagramEditor"><a name="DiagramLayout">More Flexible Diagram Layout Storage</a></a></h2>

<p>Diagram Editor can now open workspace files, non-workspace files and non-local files. Developer can
choose to store diagram's layout information in a separate file in the same folder as the file being
edited, or a computed unique folder in project's .setting directory or in current workspace's .metadata directory.
Third party developers can also provide a customized layout storage service. The service should extend
<font color="#888888">DiagramLayoutPersistenceService</font> class. The architecture sample has been
modified to provide an "in place" layout storage which stores the diagram layout info in  
architecture.xml file. Developers can use that as an example if they want to implement their own
layout storage service.</p>

<p>The diagram layout storage mechanism is controlled by diagram page definition's "LayoutStorage" property.</p>


<h2><a name="DiagramContextHelp">Diagram Context Help</a></h2>

<p>Diagram Editor now supports context sensitive help. When a node or connection is selected, hitting "F1"
will display the context help associated with the node/connection model element through the @Documentation 
annotation. If nothing is selected in the diagram editor, hitting "F1" will display the context help associated
with the root model element for the diagram editor.</p>


<h2><a name="NewDiagramActions">New Diagram Actions</a></h2>

<p>Easily delete all bend points for one or more connections.</p>

<p>Select all diagram parts or just the nodes using a pair of new actions. Alternatively, use
Ctrl + A key binding to select everything.</p>


<h2><a name="MutipleDiagramPartsActions">Actions for Multiple Diagram Parts</a></h2>

<p>Develop actions that work in the context where multiple nodes and/or connections are selected. Such
actions should specify "Sapphire.Diagram.MultipleParts" context and be contributed at diagram page level.</P>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code>public class ExampleActionHandler extends SapphireActionHandler
{
    @Override
    protected Object run( SapphireRenderingContext context ) 
    {
        final SapphireDiagramEditorPagePart page = (SapphireDiagramEditorPagePart) getPart();
        
        for( ISapphirePart selectedPart : page.getSelections() )
        {
            if( selectedPart instanceof DiagramNodePart )
            {
                ...
            }
            else if( selectedPart instanceof DiagramConnectionPart )
            {
                ...
            }
        }
        
        ...
        
        return null;
    }
}</code></pre>

<pre class="source-code"><code>&lt;diagram-page>
    &lt;action>
        &lt;id>Example&lt;/id>
        &lt;label>example&lt;/label>
        &lt;context>Sapphire.Diagram.MultipleParts&lt;/context>
    &lt;/action>
    &lt;action-handler>
        &lt;action>Example&lt;/action>
        &lt;impl>ExampleActionHandler&lt;/impl>
    &lt;/action-handler>
&lt;/diagram-page></code></pre>


<h2><a name="ExpressionLanguage"><a name="ImageFunction">Image Function</a></a></h2>

<p>Returns the image associated with the context model element.</p>

<p style="margin-left: 20px;"><b>Examples</b></p>

<pre class="source-code"><code>${ Image() }
${ Address.Image() }
${ BusinessExpense ? BusinessAccount.Image() : PersonalAccount.Image() }</code></pre>


<h2><a name="ExprInPropertyEditorLabel">Use in Property Editor Label</a></h2>

<p>Use expression language when overriding the label in a property editor.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;property-editor>
    &lt;property>Name&lt;/property></font>
    &lt;label>${ Type == "Business" ? "company" : "name" }&lt;/label>
<font color="#888888">&lt;/property-editor></font></code></pre>


<h2><a name="Services"><a name="PartServices">Part Services</a></a></h2>

<p>Services can now be attached to parts. This enhancement allows extensibility for parts to be handled with
the same API that adopters should already be familiar with from the model layer.</p>

<p>To attach a part service via the extension system, use Sapphire.Part context.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;extension></font>
    &lt;service>
        &lt;id>Example.CustomLayoutPersistenceService&lt;/id>
        &lt;context>Sapphire.Part&lt;/context>
        &lt;type>org.eclipse.sapphire.ui.diagram.layout.DiagramLayoutPersistenceService&lt;/type>
        &lt;factory>org.example.CustomLayoutPersistenceService$Factory&lt;/factory>
    &lt;/service>
<code><font color="#888888">&lt;/extension></font></code></pre>

<p>Services can also be attached to parts at the local level in sdef.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">&lt;definition>
    &lt;diagram-page></font>
        &lt;service>            
            &lt;implementation>CustomLayoutPersistenceService&lt;/implementation>
        &lt;/service>
    <font color="#888888">&lt;/diagram-page>
&lt;/definition></font></code></pre>


<h2><a name="AdapterService">AdapterService</a></h2>

<p>The AdapterService provides means to extend the behavior of the adapt method in a given context.</p>

<p>For example, out of the box, Sapphire can adapt IModelElement to IProject assuming that the model is using
an IFile for the underlying resource store.  However, in some cases there may be no underlying IFile, so the
default logic will no be able to find IProject. To solve this problem, we can introduce an adapter service to 
provide a custom method for adopting IModelElement to IProject.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code><font color="#888888">@GenerateImpl</font>
@Service( impl = NewProjectFileOpAdapter.class )

<font color="#888888">public interface INewProjectFileOp extends IModelElement
{
    ...
}</font></code></pre>

<pre class="source-code"><code>public class NewProjectFileOpAdapter extends AdapterService
{
    @Override
    public &lt;A&gt; A adapt( Class&lt;A&gt; adapterType )
    {
        if( IProject.class == adapterType )
        {
            INewProjectFileOp op = context( INewProjectFileOp.class );
            IProject project = op.getProject().resolve();

            if( project != null )
            {
                return adapterType.cast( project );
            }
        }

        return null;
    }
}</code></pre>


<h2><a name="EqualityService">EqualityService</a></h2>

<p>The EqualityService provides means to implement equals() and hashCode() methods when the context object doesn't support
implementing these methods directly. One such context is model elements, where the framework does not rely on a particular
implementation of these methods, but having these methods behave in a way consistent with semantics of the data being modeled
can be useful for other purposes.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<pre class="source-code"><code>public class ContactEqualityService extends EqualityService
{
    @Override
    public boolean doEquals( Object obj )
    {
        Contact c1 = context( Contact.class );
        Contact c2 = (Contact) obj;
        
        return equal( c1.getLastName().getText(), c2.getLastName().getText() ) &&
               equal( c1.getFirstName().getText(), c2.getFirstName().getText() );
    }
    
    @Override
    public int doHashCode()
    {
        Contact c = context( Contact.class );
        String lastName = c.getLastName().getText();
        String firstName = c.getFirstName().getText();
        
        return ( lastName == null ? 1 : lastName.hashCode() ) ^ ( firstName == null ? 1 : firstName.hashCode() );
    }
    
    private static boolean equal( Object obj1, Object obj2 )
    {
        if( obj1 == obj2 )
        {
            return true;
        }
        else if( obj1 != null && obj2 != null )
        {
            return obj1.equals( obj2 );
        }
        
        return false;
    }
}</code></pre>


<a name="ListSelectionService"><h2>ListSelectionService</h2></a>

<p>The ListSelectionService functions as a conduit between the presentation layer and anything that may want to see or 
change the selection. The presentation layer pushes selection changes made by the user to ListSelectionService and at
the same time listens for changes to selection coming from ListSelectionService.</p>

<p>An implementation of this service is provided with Sapphire. This service is not intended to be implemented by adopters.</p>

<p style="margin-left: 20px;"><b>Example</b></p>

<p style="margin-left: 20px;">In this example, an action handler attaches a listener to the ListSelectionService to 
refresh action handler's enablement state when selection changes.</p>

<pre class="source-code"><code>
<font color="#888888">public class ExampleActionHandler extends SapphireActionHandler
{
    @Override
    public void init( SapphireAction action, ActionHandlerDef def )
    {
        super.init( action, def );</font>
        
        final ListSelectionService selectionService = action.getPart().service( ListSelectionService.class );
        
        final Listener selectionListener = new Listener()
        {
            @Override
            public void handle( Event event )
            {
                refreshEnablementState();
            }
        };
        
        selectionService.attach( selectionListener );
        
        attach
        (
            new Listener()
            {
                @Override
                public void handle( Event event )
                {
                    if( event instanceof DisposeEvent )
                    {
                        selectionService.detach( selectionListener );
                    }
                }
            }
        );
    <font color="#888888">}
}</font></code></pre>


<h2><a name="Miscellaneous"><a name="ModelElementDisposed">IModelElement.disposed()</a></a></h2>

<p>The new IModelElement.disposed() method provides a way to check if a model element has been disposed
already.</p>


<div class="copyright">Copyright (c) 2012 Oracle and Liferay<br/>
Content made available under the terms of <a href="http://www.eclipse.org/legal/epl-v10.html">Eclipse Public License</a>.</div>


</body>

</html>